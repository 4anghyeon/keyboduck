import React, {useState} from 'react';
import styles from '@/pages/question/edit/[questionId]/index.module.css';
import {useToast} from '@/hooks/useToast';
import {useMutation, useQuery, useQueryClient} from '@tanstack/react-query';
import {editQuestion, getQuestion} from '@/pages/api/question';
import {useRouter} from 'next/router';
import {OPTION} from '../../write';
import Swal from 'sweetalert2';
import Loading from '@/components/layout/loading/Loading';

const EditQuestion = () => {
  const {
    isLoading,
    isError,
    data: questionList,
  } = useQuery({
    queryKey: ['getQuestion'],
    queryFn: getQuestion,
    refetchOnWindowFocus: false,
  });
  const router = useRouter();
  const questionId: number | null = Number(router.query.questionId);
  const findEditQuestion = questionList?.getQuestionData?.find(question => question.id === questionId);

  const queryClient = useQueryClient();
  const editQuestionMutation = useMutation({
    mutationFn: editQuestion,
    onSuccess: () => {
      queryClient.invalidateQueries({queryKey: ['getQuestion']});
      successTopCenter({message: 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', timeout: 2000});
      router.push(`/question/${findEditQuestion?.id}`);
    },
    onError: () => {
      errorTopCenter({message: 'ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤ğŸ˜­ ìˆ˜ì • ì „ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤'});
      router.push(`/question/${findEditQuestion?.id}`);
    },
  });

  const {successTopCenter, errorTopCenter} = useToast();
  const [title, setTitle] = useState<string>(findEditQuestion?.title || '');
  const [content, setContent] = useState<string>(findEditQuestion?.content || '');
  const [category, setCategory] = useState<string>(findEditQuestion?.category || 'ì¹´í…Œê³ ë¦¬ ì„ íƒ');

  const onChangeTitle = (e: React.ChangeEvent<HTMLInputElement>) => setTitle(e.target.value);
  const onChangeContents = (e: React.ChangeEvent<HTMLTextAreaElement>) => setContent(e.target.value);
  const onChangeCategory = (e: React.ChangeEvent<HTMLSelectElement>) => setCategory(e.target.value);

  const clickCompletionQuestion = (id: number) => {
    editQuestionMutation.mutate({id, title, content, category});
  };

  const clickCancelEdit = () => {
    if (
      title !== findEditQuestion?.title ||
      content !== findEditQuestion?.content ||
      category !== findEditQuestion?.category
    ) {
      Swal.fire({
        title: 'ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        text: 'âš ï¸ ë³€ê²½ëœ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#b0b0b0',
        cancelButtonColor: '#83e0a5',
        confirmButtonText: 'ë„¤',
        cancelButtonText: 'ì•„ë‹ˆìš”',
      }).then(result => {
        if (result.isConfirmed) {
          Swal.fire({
            icon: 'success',
          });
          router.push(`/question/${findEditQuestion?.id}`);
        }
      });
    }
    router.push(`/question/${findEditQuestion?.id}`);
  };

  if (isLoading) {
    return <Loading />;
  }
  if (isError) {
    return <div>ğŸ™‡ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤ğŸ™‡</div>;
  }

  return (
    <div className={styles['qna-edit-container']}>
      <div className={styles['qna-edit-title']}>
        <h2>QnA</h2>
      </div>
      <div className={styles['qna-edit-select']}>
        <select value={category} onChange={onChangeCategory}>
          {OPTION.map(item => {
            return (
              <option key={item} value={item}>
                {item}
              </option>
            );
          })}
        </select>
      </div>
      <div className={styles['qna-edit-contents']}>
        <input type="text" value={title} onChange={onChangeTitle} placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
        <textarea rows={18} value={content} onChange={onChangeContents} placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
      </div>
      <div className={styles['qna-edit-registration-btn']}>
        <button onClick={clickCancelEdit}>ì·¨ì†Œí•˜ê¸°</button>
        <button onClick={() => clickCompletionQuestion(findEditQuestion?.id || 0)}>ë“±ë¡í•˜ê¸°</button>
      </div>
    </div>
  );
};

export default EditQuestion;
